<script type="text/javascript">
  RED.nodes.registerType('end-events', {
    category: 'RMF Dynamic Events',
    color: '#4A90E2',
    defaults: {
      name: { value: '' },
      robot_name: { value: '' },
      robot_fleet: { value: '' },
      start_events_node: { value: '' }
    },
    inputs: 1,
    outputs: 1,
    icon: 'rmf.svg',
    label: function () {
      return this.name || 'END';
    },
    paletteLabel: 'END',
    oneditprepare: function() {
      const node = this;
      
      // Initialize data storage
      node.rmfData = {
        robots: [],
        fleets: []
      };
      
      // Load RMF data from context
      loadRMFData();
      
      // Setup change handlers
      setupChangeHandlers();
      
      // Setup refresh button
      setupRefreshButton();
      
      // Setup start-events node selection
      setupStartEventsSelection();
      
      function setupStartEventsSelection() {
        populateStartEventsDropdown();
        
        // Handle start-events node selection change
        $('#node-input-start_events_node').on('change', function() {
          const selectedNodeId = $(this).val();
          if (selectedNodeId && selectedNodeId !== '') {
            // Auto-populate robot and fleet from selected start-events node
            const selectedNode = RED.nodes.node(selectedNodeId);
            if (selectedNode && selectedNode.type === 'start-events') {
              // Set robot name if start-events has a specific robot selected
              if (selectedNode.robot_name && selectedNode.robot_name !== '' && selectedNode.robot_name !== '__RMF_DEFINED__' && selectedNode.robot_name !== '__AUTO_DEFINED__') {
                $('#node-input-robot_name').val(selectedNode.robot_name);
                
                // Also set fleet if available
                if (selectedNode.robot_fleet && selectedNode.robot_fleet !== '') {
                  $('#node-input-robot_fleet').val(selectedNode.robot_fleet);
                }
              }
            }
          }
        });
        
        // Handle refresh start-events list
        $('#refresh-start-events').on('click', function() {
          populateStartEventsDropdown();
        });
      }
      
      function populateStartEventsDropdown() {
        const startEventsSelect = $('#node-input-start_events_node');
        startEventsSelect.empty();
        startEventsSelect.append('<option value="">Use flow connection (default)</option>');
        
        // Find all start-events nodes in the workspace
        const startEventsNodes = [];
        RED.nodes.eachNode(function(node) {
          if (node.type === 'start-events') {
            startEventsNodes.push(node);
          }
        });
        
        if (startEventsNodes.length > 0) {
          startEventsNodes.forEach(function(node) {
            const nodeName = node.name || `${node.type} (${node.id.substring(0, 8)})`;
            let robotInfo = '';
            if (node.robot_name && node.robot_name !== '' && node.robot_name !== '__RMF_DEFINED__' && node.robot_name !== '__AUTO_DEFINED__') {
              robotInfo = ` - ${node.robot_name}`;
              if (node.robot_fleet && node.robot_fleet !== '') {
                robotInfo += `/${node.robot_fleet}`;
              }
            } else if (node.robot_name === '__RMF_DEFINED__') {
              robotInfo = ' - RMF defined';
            } else if (node.robot_name === '__AUTO_DEFINED__') {
              robotInfo = ' - Auto defined';
            } else {
              robotInfo = ' - User defined';
            }
            startEventsSelect.append(`<option value="${node.id}">${nodeName}${robotInfo}</option>`);
          });
        } else {
          startEventsSelect.append('<option value="" disabled>No start-events nodes found</option>');
        }
        
        // Restore the current selection if it exists
        if (node.start_events_node) {
          startEventsSelect.val(node.start_events_node);
        }
      }
      
      function setupRefreshButton() {
        $('#refresh-rmf-data').on('click', function() {
          const button = $(this);
          const originalText = button.html();
          
          // Show loading state
          button.html('<i class="fa fa-spinner fa-spin"></i> Loading...');
          button.prop('disabled', true);
          
          // Reload data
          loadRMFData().then(() => {
            // Restore button
            button.html(originalText);
            button.prop('disabled', false);
          }).catch(() => {
            button.html(originalText);
            button.prop('disabled', false);
          });
        });
      }
      
      async function loadRMFData() {
        try {
          // Clear any existing status messages
          $('.rmf-data-status').remove();
          
          const response = await $.get('/rmf/data');
          
          if (response && response.robots) {
            node.rmfData.robots = response.robots;
            node.rmfData.fleets = [...new Set(response.robots.map(r => r.fleet))];
            
            populateDropdowns();
            showStatus('success', `Loaded ${response.robots.length} robots`);
          } else {
            node.rmfData.robots = [];
            node.rmfData.fleets = [];
            populateDropdowns();
            showStatus('warning', 'No robot data available');
          }
          
        } catch (error) {
          console.error('Failed to load RMF data:', error);
          node.rmfData.robots = [];
          node.rmfData.fleets = [];
          populateDropdowns();
          showStatus('error', 'Failed to load RMF data');
        }
      }
      
      function showStatus(type, message) {
        // Remove existing status
        $('.rmf-data-status').remove();
        
        let statusClass = 'form-tips';
        let icon = 'fa-info-circle';
        let color = '#666';
        
        if (type === 'warning') {
          statusClass = 'form-tips';
          icon = 'fa-exclamation-triangle';
          color = '#ff9800';
        } else if (type === 'error') {
          statusClass = 'form-tips';
          icon = 'fa-exclamation-circle';
          color = '#f44336';
        } else if (type === 'success') {
          statusClass = 'form-tips';
          icon = 'fa-check-circle';
          color = '#4caf50';
        }
        
        const statusDiv = $(`
          <div class="rmf-data-status ${statusClass}" style="color: ${color}; margin-top: 10px;">
            <i class="fa ${icon}" style="margin-right: 5px;"></i>
            ${message}
          </div>
        `);
        
        $('#node-input-config').closest('.form-row').after(statusDiv);
      }
      
      function populateDropdowns() {
        // Populate robot dropdown
        const robotSelect = $('#node-input-robot_name');
        robotSelect.empty();
        robotSelect.append('<option value="">Use msg.rmf_robot_name</option>');
        
        if (node.rmfData.robots && node.rmfData.robots.length > 0) {
          node.rmfData.robots.forEach(robot => {
            robotSelect.append(`<option value="${robot.name}" data-fleet="${robot.fleet}">${robot.name} (${robot.fleet})</option>`);
          });
        }
        
        // Populate fleet dropdown
        const fleetSelect = $('#node-input-robot_fleet');
        fleetSelect.empty();
        fleetSelect.append('<option value="">Use msg.rmf_robot_fleet</option>');
        
        if (node.rmfData.fleets && node.rmfData.fleets.length > 0) {
          node.rmfData.fleets.forEach(fleet => {
            fleetSelect.append(`<option value="${fleet}">${fleet}</option>`);
          });
        }
        
        // Set current values
        robotSelect.val(node.robot_name || '');
        fleetSelect.val(node.robot_fleet || '');
      }
      
      function setupChangeHandlers() {
        // Robot selection change handler
        $('#node-input-robot_name').on('change', function() {
          const selectedRobot = $(this).val();
          const selectedOption = $(this).find('option:selected');
          const robotFleet = selectedOption.data('fleet');
          
          // Only auto-select fleet if:
          // 1. A specific robot is selected (not "Use msg.rmf_robot_name")
          // 2. Fleet is currently set to "Use msg.rmf_robot_fleet" (empty value)
          if (selectedRobot && selectedRobot !== '' && robotFleet) {
            const currentFleetSelection = $('#node-input-robot_fleet').val();
            // Only auto-select if fleet dropdown is set to "Use msg.rmf_robot_fleet" (empty value)
            if (currentFleetSelection === '') {
              $('#node-input-robot_fleet').val(robotFleet);
            }
          }
        });
        
        // Fleet selection change handler
        $('#node-input-robot_fleet').on('change', function() {
          const selectedFleet = $(this).val();
          const robotSelect = $('#node-input-robot_name');
          
          if (selectedFleet && selectedFleet !== '') {
            // Filter robots to only show those from the selected fleet
            const currentRobot = robotSelect.val();
            robotSelect.empty();
            robotSelect.append('<option value="">Use msg.rmf_robot_name</option>');
            
            if (node.rmfData.robots && node.rmfData.robots.length > 0) {
              node.rmfData.robots.forEach(robot => {
                if (robot.fleet === selectedFleet) {
                  robotSelect.append(`<option value="${robot.name}" data-fleet="${robot.fleet}">${robot.name} (${robot.fleet})</option>`);
                }
              });
            }
            
            // Restore selection if robot is from the selected fleet
            const robotFromFleet = node.rmfData.robots.find(r => r.name === currentRobot && r.fleet === selectedFleet);
            if (robotFromFleet) {
              robotSelect.val(currentRobot);
            }
          } else {
            // If "Use msg.rmf_robot_fleet" is selected, show all robots but don't reset selection
            const currentRobot = robotSelect.val();
            robotSelect.empty();
            robotSelect.append('<option value="">Use msg.rmf_robot_name</option>');
            
            if (node.rmfData.robots && node.rmfData.robots.length > 0) {
              node.rmfData.robots.forEach(robot => {
                robotSelect.append(`<option value="${robot.name}" data-fleet="${robot.fleet}">${robot.name} (${robot.fleet})</option>`);
              });
            }
            
            // Restore the current robot selection
            robotSelect.val(currentRobot);
          }
        });
      }
    }
  });
</script>

<script type="text/html" data-template-name="end-events">
  <div class="form-row">
    <label for="node-input-name">Name</label>
    <input type="text" id="node-input-name">
  </div>
  <div class="form-row">
    <button type="button" id="refresh-rmf-data" class="red-ui-button" style="width: auto;">
      <i class="fa fa-refresh"></i> Refresh Data
    </button>
  </div>
  
  <div class="form-row">
    <label for="node-input-start_events_node">Start-Events Node</label>
    <div style="display: flex; align-items: center;">
      <select id="node-input-start_events_node" style="width: calc(100% - 120px);">
        <option value="">Use flow connection (default)</option>
      </select>
      <button type="button" id="refresh-start-events" class="red-ui-button" style="margin-left: 10px; width: auto;">
        <i class="fa fa-refresh"></i>
      </button>
    </div>
    <div class="form-tips">Optional: Select a specific start-events node to logically pair with this end-events node. This allows ending events without requiring a direct flow connection, useful when metadata might be lost between nodes.</div>
  </div>
  
  <div class="form-row">
    <label for="node-input-robot_name">Robot Name</label>
    <select id="node-input-robot_name" style="width: 100%;">
      <option value="">Use msg.rmf_robot_name</option>
    </select>
  </div>
  
  <div class="form-row">
    <label for="node-input-robot_fleet">Robot Fleet</label>
    <select id="node-input-robot_fleet" style="width: 100%;">
      <option value="">Use msg.robot_fleet</option>
    </select>
  </div>
  
  <div class="form-tips">
    <b>Purpose:</b><br/>
    Ends active RMF events for robots. This node should be connected after a goto-place node to complete the workflow.<br/><br/>
    
    <b>Setup Requirements:</b><br/>
    • Connect this node after start-events and action nodes (which provide RMF config)<br/>
    • Use "Refresh Data" button if dropdowns are empty<br/><br/>
    
    <b>Usage:</b><br/>
    • Robot name and fleet can come from previous nodes via RMF metadata<br/>
    • Use "Use msg.xxx" dropdown options to pass values via message properties<br/>
    • Connect after goto-place node for complete workflow: start-events → goto-place → end-events
  </div>
</script>

<script type="text/html" data-help-name="end-events">
  <p>Completes the robot's dynamic event flow (ends dynamic event and task). Connect this node to end the dynamic event flow when all robot actions are finished.</p>
  
  <h3>Configuration</h3>
  <dl class="message-properties">
    <dt>Start-Events Node <span class="property-type">string</span></dt>
    <dd>Optional: Select a specific start-events node to logically pair with this end-events node. This allows ending events without requiring a direct flow connection and provides robot/task metadata even if lost between nodes.</dd>
    
    <dt>Robot Name <span class="property-type">string</span></dt>
    <dd>The name of the robot (optional). Select from dropdown or use "Use msg.robot_name" to pass via message. Usually passed from previous nodes via RMF metadata or automatically populated from selected start-events node.</dd>
    
    <dt>Robot Fleet <span class="property-type">string</span></dt>
    <dd>The fleet the robot belongs to (optional). Auto-selected when robot is chosen. Usually passed from previous nodes via RMF metadata or automatically populated from selected start-events node.</dd>
  </dl>
  
  <h3>Inputs</h3>
  <dl class="message-properties">
    <dt>msg.rmf_task_id <span class="property-type">string</span></dt>
    <dd>RMF task ID metadata (preferred - automatically set by start-events node)</dd>
    
    <dt>msg.rmf_robot_name <span class="property-type">string</span></dt>
    <dd>Robot name metadata (preferred - automatically set by start-events node)</dd>
    
    <dt>msg.rmf_robot_fleet <span class="property-type">string</span></dt>
    <dd>Robot fleet metadata (preferred - automatically set by start-events node)</dd>
    
    <dt>msg.robot_name <span class="property-type">string</span></dt>
    <dd>Robot name (fallback when "Use msg.robot_name" is selected)</dd>
    
    <dt>msg.robot_fleet <span class="property-type">string</span></dt>
    <dd>Robot fleet (fallback when "Use msg.robot_fleet" is selected)</dd>
  </dl>
  
  <h3>Outputs</h3>
  <dl class="message-properties">
    <dt>payload.status <span class="property-type">string</span></dt>
    <dd>"completed" when events are successfully ended, "failed" on failure, "error" on exception</dd>
    
    <dt>payload.action <span class="property-type">string</span></dt>
    <dd>"end" - indicates this was an end events operation</dd>
    
    <dt>payload.robot_name <span class="property-type">string</span></dt>
    <dd>The robot name</dd>
    
    <dt>payload.robot_fleet <span class="property-type">string</span></dt>
    <dd>The robot fleet</dd>
    
    <dt>payload.task_id <span class="property-type">string</span></dt>
    <dd>The RMF task ID that was ended</dd>
    
    <dt>payload.timestamp <span class="property-type">string</span></dt>
    <dd>Timestamp when the events were ended</dd>
  </dl>
  
  <h3>Details</h3>
  <p>This node sends an "end" dynamic event to RMF to complete the task lifecycle. It expects to receive robot and task information from preceding nodes in the dynamic event flow.</p>
  
  <p><strong>Dynamic Event Flow:</strong> start-events → goto-place → end-events for complete dynamic event flow management.</p>
  
  <p><strong>Start-Events Node Selection:</strong> You can optionally select a specific start-events node to logically pair with this end-events node. This feature is useful when:</p>
  <ul>
    <li>The flow connection might be broken or indirect</li>
    <li>RMF metadata might be lost between nodes</li>
    <li>You want to ensure the correct task is ended regardless of message routing</li>
  </ul>
  
  <p><strong>Prerequisites:</strong> The robot must have an active RMF task with a dynamic event sequence. This is typically provided by connecting this node at the end of your dynamic event flow or by selecting a start-events node.</p>
  
  <p><strong>RMF Metadata Priority:</strong> This node uses metadata in this order:</p>
  <ol>
    <li>RMF metadata from input message (msg.rmf_*)</li>
    <li>Metadata from selected start-events node</li>  
    <li>Message properties (msg.robot_name, etc.)</li>
    <li>Node configuration</li>
  </ol>
</script>