<script type="text/javascript">
  RED.nodes.registerType('cancel-task', {
    category: 'RMF',
    color: '#ff6b6b',
    defaults: {
      name: { value: '' },
      config: { type: 'rmf-config', required: true },
      robot_name: { value: '' },
      robot_fleet: { value: '' }
    },
    inputs: 1,
    outputs: 1,
    icon: 'font-awesome/fa-times-circle',
    label: function () {
      return this.name || 'cancel-task';
    },
    oneditprepare: function() {
      const node = this;
      
      // Initialize data storage
      node.rmfData = {
        robots: [],
        fleets: []
      };
      
      // Load RMF data from context
      loadRMFData();
      
      // Setup change handlers
      setupChangeHandlers();
      
      // Setup refresh button
      setupRefreshButton();
      
      function setupRefreshButton() {
        $('#refresh-rmf-data').on('click', function() {
          const button = $(this);
          const originalText = button.html();
          
          // Show loading state
          button.html('<i class="fa fa-spinner fa-spin"></i> Loading...');
          button.prop('disabled', true);
          
          // Reload data
          loadRMFData();
          
          // Reset button after delay
          setTimeout(() => {
            button.html(originalText);
            button.prop('disabled', false);
          }, 1000);
        });
      }
      
      function loadRMFData() {
        // Fetch RMF data from the global context
        $.getJSON('/rmf/data', function(data) {
          node.rmfData = data;
          
          if (data.status === 'not_initialized') {
            console.warn('RMF context not initialized - dropdowns will be empty');
            showDataStatus('RMF not initialized. Deploy RMF Config node first.', 'warning');
          } else if (data.status === 'error') {
            console.error('Error loading RMF data:', data.message);
            showDataStatus('Error loading RMF data: ' + data.message, 'error');
          } else if (data.robots.length === 0) {
            console.warn('No RMF robots available - dropdowns will be empty');
            showDataStatus('No RMF robots available. Check RMF system status.', 'warning');
          } else {
            showDataStatus(`Loaded ${data.robots.length} robots from ${data.fleets.length} fleets`, 'success');
          }
          
          populateDropdowns();
        }).fail(function(xhr, status, error) {
          console.error('Failed to load RMF data:', error);
          showDataStatus('Failed to connect to RMF data source', 'error');
          node.rmfData = { robots: [], fleets: [] };
          populateDropdowns();
        });
      }
      
      function showDataStatus(message, type) {
        // Remove any existing status message
        $('.rmf-data-status').remove();
        
        // Add status message
        let statusClass = 'form-tips';
        let icon = 'fa-info-circle';
        let color = '#666';
        
        if (type === 'warning') {
          statusClass = 'form-tips';
          icon = 'fa-exclamation-triangle';
          color = '#ff9800';
        } else if (type === 'error') {
          statusClass = 'form-tips';
          icon = 'fa-exclamation-circle';
          color = '#f44336';
        } else if (type === 'success') {
          statusClass = 'form-tips';
          icon = 'fa-check-circle';
          color = '#4caf50';
        }
        
        const statusDiv = $(`
          <div class="rmf-data-status ${statusClass}" style="color: ${color}; margin-top: 10px;">
            <i class="fa ${icon}" style="margin-right: 5px;"></i>
            ${message}
          </div>
        `);
        
        $('#node-input-config').closest('.form-row').after(statusDiv);
      }
      
      function populateDropdowns() {
        // Populate robot dropdown
        const robotSelect = $('#node-input-robot_name');
        robotSelect.empty();
        robotSelect.append('<option value="">Use msg.rmf_robot_name</option>');
        
        if (node.rmfData.robots && node.rmfData.robots.length > 0) {
          node.rmfData.robots.forEach(robot => {
            robotSelect.append(`<option value="${robot.name}" data-fleet="${robot.fleet}">${robot.name} (${robot.fleet})</option>`);
          });
        }
        
        // Populate fleet dropdown
        const fleetSelect = $('#node-input-robot_fleet');
        fleetSelect.empty();
        fleetSelect.append('<option value="">Use msg.rmf_robot_fleet</option>');
        
        if (node.rmfData.fleets && node.rmfData.fleets.length > 0) {
          node.rmfData.fleets.forEach(fleet => {
            fleetSelect.append(`<option value="${fleet}">${fleet}</option>`);
          });
        }
        
        // Set current values
        robotSelect.val(node.robot_name || '');
        fleetSelect.val(node.robot_fleet || '');
      }
      
      function setupChangeHandlers() {
        // Robot selection change handler
        $('#node-input-robot_name').on('change', function() {
          const selectedRobot = $(this).val();
          const selectedOption = $(this).find('option:selected');
          const robotFleet = selectedOption.data('fleet');
          
          // Only auto-select fleet if:
          // 1. A specific robot is selected (not "Use msg.rmf_robot_name")
          // 2. Fleet is currently set to "Use msg.rmf_robot_fleet" (empty value)
          if (selectedRobot && selectedRobot !== '' && robotFleet) {
            const currentFleetSelection = $('#node-input-robot_fleet').val();
            // Only auto-select if fleet dropdown is set to "Use msg.rmf_robot_fleet" (empty value)
            if (currentFleetSelection === '') {
              $('#node-input-robot_fleet').val(robotFleet);
            }
          }
        });
        
        // Fleet selection change handler
        $('#node-input-robot_fleet').on('change', function() {
          const selectedFleet = $(this).val();
          const robotSelect = $('#node-input-robot_name');
          
          if (selectedFleet && selectedFleet !== '') {
            // Filter robots to only show those from the selected fleet
            const currentRobot = robotSelect.val();
            robotSelect.empty();
            robotSelect.append('<option value="">Use msg.rmf_robot_name</option>');
            
            if (node.rmfData.robots && node.rmfData.robots.length > 0) {
              node.rmfData.robots.forEach(robot => {
                if (robot.fleet === selectedFleet) {
                  robotSelect.append(`<option value="${robot.name}" data-fleet="${robot.fleet}">${robot.name} (${robot.fleet})</option>`);
                }
              });
            }
            
            // Restore selection if robot is from the selected fleet
            const robotFromFleet = node.rmfData.robots.find(r => r.name === currentRobot && r.fleet === selectedFleet);
            if (robotFromFleet) {
              robotSelect.val(currentRobot);
            }
          } else {
            // If "Use msg.rmf_robot_fleet" is selected, show all robots but don't reset selection
            const currentRobot = robotSelect.val();
            robotSelect.empty();
            robotSelect.append('<option value="">Use msg.rmf_robot_name</option>');
            
            if (node.rmfData.robots && node.rmfData.robots.length > 0) {
              node.rmfData.robots.forEach(robot => {
                robotSelect.append(`<option value="${robot.name}" data-fleet="${robot.fleet}">${robot.name} (${robot.fleet})</option>`);
              });
            }
            
            // Restore the current robot selection
            robotSelect.val(currentRobot);
          }
        });
      }
    },
    oneditsave: function() {
      // No validation needed - robot info can come from message properties
      // The node will validate at runtime and provide appropriate error messages
      return true;
    }
  });
</script>

<script type="text/html" data-template-name="cancel-task">
  <div class="form-row">
    <label for="node-input-name">Name</label>
    <input type="text" id="node-input-name">
  </div>
  <div class="form-row">
    <label for="node-input-config"><i class="fa fa-cogs"></i> RMF Config</label>
    <input type="text" id="node-input-config" style="width: 60%;">
    <button type="button" id="refresh-rmf-data" class="red-ui-button" style="margin-left: 10px; width: auto;">
      <i class="fa fa-refresh"></i> Refresh Data
    </button>
  </div>
  
  <div class="form-row">
    <label for="node-input-robot_name">Robot Name <span style="color: red;">*</span></label>
    <select id="node-input-robot_name" style="width: 100%;">
      <option value="">Use msg.rmf_robot_name</option>
    </select>
  </div>
  
  <div class="form-row">
    <label for="node-input-robot_fleet">Robot Fleet <span style="color: red;">*</span></label>
    <select id="node-input-robot_fleet" style="width: 100%;">
      <option value="">Use msg.rmf_robot_fleet</option>
    </select>
  </div>
  
  <div class="form-tips">
    <b>Setup Requirements:</b><br/>
    • Deploy and connect an RMF Config node first<br/>
    • Wait for RMF system to initialize and load data<br/>
    • Use "Refresh Data" button if dropdowns are empty<br/><br/>
    
    <b>Usage Tips:</b><br/>
    • Both Robot name and fleet are required<br/>
    • Robot name and fleet are constrained to each other<br/>
    • If unique robot name is provided, fleet will be auto-selected<br/>
    • Use "Use msg.rmf_xxx" dropdown options to pass values via message properties<br/>
    • The node will cancel the currently active dynamic event for the specified robot<br/>
    • Robot must have an active dynamic event with valid dynamic_event_id
  </div>
</script>

<script type="text/html" data-help-name="cancel-task">
  <p>Cancel an active dynamic event task for a specified robot using RMF. Requires an RMF Config node.</p>
  
  <h3>Configuration</h3>
  <dl class="message-properties">
    <dt>Robot Name <span class="property-type">string</span></dt>
    <dd>The name of the robot whose task should be canceled (required). Select from dropdown or use "Use msg.rmf_robot_name" to pass via message.</dd>
    
    <dt>Robot Fleet <span class="property-type">string</span></dt>
    <dd>The fleet the robot belongs to (required). Auto-selected when robot is chosen. Select from dropdown or use "Use msg.rmf_robot_fleet" to pass via message.</dd>
  </dl>
  
  <h3>Inputs</h3>
  <dl class="message-properties">
    <dt>msg.rmf_robot_name <span class="property-type">string</span></dt>
    <dd>Robot name (used when "Use msg.rmf_robot_name" is selected)</dd>
    
    <dt>msg.rmf_robot_fleet <span class="property-type">string</span></dt>
    <dd>Robot fleet (used when "Use msg.rmf_robot_fleet" is selected)</dd>
  </dl>
  
  <h3>Outputs</h3>
  <dl class="message-properties">
    <dt>msg.payload <span class="property-type">object</span></dt>
    <dd>Contains the result of the cancel operation, including robot information and status</dd>
    
    <dt>msg.payload.status <span class="property-type">string</span></dt>
    <dd>Status of the operation: "success", "error", "warning", or "exception"</dd>
    
    <dt>msg.payload.robot_name <span class="property-type">string</span></dt>
    <dd>Name of the robot whose task was canceled</dd>
    
    <dt>msg.payload.robot_fleet <span class="property-type">string</span></dt>
    <dd>Fleet of the robot whose task was canceled</dd>
    
    <dt>msg.payload.dynamic_event_seq <span class="property-type">number</span></dt>
    <dd>Dynamic event sequence number that was canceled (if successful)</dd>
    
    <dt>msg.payload.dynamic_event_id <span class="property-type">BigInt</span></dt>
    <dd>Dynamic event ID that was canceled (if successful)</dd>
  </dl>
  
  <h3>Details</h3>
  <p>This node cancels an active dynamic event task for a specified robot using RMF's dynamic event action server. The node automatically retrieves the necessary information (dynamic_event_seq and dynamic_event_id) from the robot's context.</p>
  
  <p><strong>Prerequisites:</strong></p>
  <ul>
    <li>The robot must have an active dynamic event task</li>
    <li>The robot context must contain valid dynamic_event_seq and dynamic_event_id</li>
    <li>RMF system must be connected and operational</li>
  </ul>
  
  <p><strong>Robot and Fleet Constraint:</strong> Robot names are tied to specific fleets. When you select a robot, its fleet is automatically selected. When you select a fleet, only robots from that fleet are shown.</p>
  
  <p><strong>Error Handling:</strong> The node provides detailed error messages if:</p>
  <ul>
    <li>Robot is not found in RMF data</li>
    <li>Robot has no active dynamic event</li>
    <li>Robot context is missing required information</li>
    <li>Cancel operation fails for any reason</li>
  </ul>
  
  <p><strong>Output Status:</strong></p>
  <ul>
    <li><strong>success:</strong> Cancel operation completed successfully</li>
    <li><strong>warning:</strong> Robot has no active task to cancel</li>
    <li><strong>error:</strong> Operation failed due to validation or RMF errors</li>
    <li><strong>exception:</strong> Unexpected error during cancel operation</li>
  </ul>
</script>
