<script type="text/javascript">
  RED.nodes.registerType('start-task', {
    category: 'RMF',
    color: '#a6bbcf',
    defaults: {
      name: { value: '' },
      config: { type: 'rmf-config', required: true },
      robot_name: { value: '' },
      robot_fleet: { value: '' },
      estimate: { value: '{}' }
    },
    inputs: 1,
    outputs: 2,
    outputLabels: ["success", "failed"],
    icon: 'font-awesome/fa-play',
    label: function () {
      return this.name || 'start-task';
    },
    oneditprepare: function() {
      const node = this;
      
      // Initialize data storage
      node.rmfData = {
        robots: [],
        fleets: []
      };
      
      // Load RMF data from context
      loadRMFData();
      
      // Setup change handlers
      setupChangeHandlers();
      
      // Setup refresh button
      setupRefreshButton();
      
      function setupRefreshButton() {
        $('#refresh-rmf-data').on('click', function() {
          const button = $(this);
          const originalText = button.html();
          
          // Show loading state
          button.html('<i class="fa fa-spinner fa-spin"></i> Loading...');
          button.prop('disabled', true);
          
          // Reload data
          loadRMFData();
          
          // Reset button after delay
          setTimeout(() => {
            button.html(originalText);
            button.prop('disabled', false);
          }, 1000);
        });
      }
      
      function loadRMFData() {
        // Fetch RMF data from the global context
        $.getJSON('/rmf/data', function(data) {
          node.rmfData = data;
          
          if (data.status === 'not_initialized') {
            console.warn('RMF context not initialized - dropdowns will be empty');
            showDataStatus('RMF not initialized. Deploy RMF Config node first.', 'warning');
          } else if (data.status === 'error') {
            console.error('Error loading RMF data:', data.message);
            showDataStatus('Error loading RMF data: ' + data.message, 'error');
          } else if (data.robots.length === 0) {
            console.warn('No RMF data available - dropdowns will be empty');
            showDataStatus('No RMF data available. Check RMF system status.', 'warning');
          } else {
            showDataStatus(`Loaded ${data.robots.length} robots`, 'success');
          }
          
          populateDropdowns();
        }).fail(function(xhr, status, error) {
          console.error('Failed to load RMF data:', error);
          showDataStatus('Failed to connect to RMF data source', 'error');
          node.rmfData = { robots: [], fleets: [] };
          populateDropdowns();
        });
      }
      
      function showDataStatus(message, type) {
        // Remove any existing status message
        $('.rmf-data-status').remove();
        
        // Add status message
        let statusClass = 'form-tips';
        let icon = 'fa-info-circle';
        let color = '#666';
        
        if (type === 'warning') {
          statusClass = 'form-tips';
          icon = 'fa-exclamation-triangle';
          color = '#ff9800';
        } else if (type === 'error') {
          statusClass = 'form-tips';
          icon = 'fa-exclamation-circle';
          color = '#f44336';
        } else if (type === 'success') {
          statusClass = 'form-tips';
          icon = 'fa-check-circle';
          color = '#4caf50';
        }
        
        const statusDiv = $(`
          <div class="rmf-data-status ${statusClass}" style="color: ${color}; margin-top: 10px;">
            <i class="fa ${icon}" style="margin-right: 5px;"></i>
            ${message}
          </div>
        `);
        
        $('#node-input-config').closest('.form-row').after(statusDiv);
      }
      
      function populateDropdowns() {
        // Populate robot dropdown
        const robotSelect = $('#node-input-robot_name');
        robotSelect.empty();
        robotSelect.append('<option value="">Use msg.rmf_robot_name</option>');
        
        if (node.rmfData.robots && node.rmfData.robots.length > 0) {
          node.rmfData.robots.forEach(robot => {
            robotSelect.append(`<option value="${robot.name}" data-fleet="${robot.fleet}">${robot.name} (${robot.fleet})</option>`);
          });
        }
        
        // Populate fleet dropdown
        const fleetSelect = $('#node-input-robot_fleet');
        fleetSelect.empty();
        fleetSelect.append('<option value="">Use msg.rmf_robot_fleet</option>');
        
        if (node.rmfData.fleets && node.rmfData.fleets.length > 0) {
          node.rmfData.fleets.forEach(fleet => {
            fleetSelect.append(`<option value="${fleet}">${fleet}</option>`);
          });
        }
        
        // Set current values
        robotSelect.val(node.robot_name || '');
        fleetSelect.val(node.robot_fleet || '');
      }
      
      function setupChangeHandlers() {
        // Robot selection change handler
        $('#node-input-robot_name').on('change', function() {
          const selectedRobot = $(this).val();
          const selectedOption = $(this).find('option:selected');
          const robotFleet = selectedOption.data('fleet');
          
          // Only auto-select fleet if:
          // 1. A specific robot is selected (not "Use msg.rmf_robot_name")
          // 2. Fleet is currently set to "Use msg.rmf_robot_fleet" (empty value)
          if (selectedRobot && selectedRobot !== '' && robotFleet) {
            const currentFleetSelection = $('#node-input-robot_fleet').val();
            // Only auto-select if fleet dropdown is set to "Use msg.rmf_robot_fleet" (empty value)
            if (currentFleetSelection === '') {
              $('#node-input-robot_fleet').val(robotFleet);
            }
          }
        });
        
        // Fleet selection change handler
        $('#node-input-robot_fleet').on('change', function() {
          const selectedFleet = $(this).val();
          const robotSelect = $('#node-input-robot_name');
          
          if (selectedFleet && selectedFleet !== '') {
            // Filter robots to only show those from the selected fleet
            const currentRobot = robotSelect.val();
            robotSelect.empty();
            robotSelect.append('<option value="">Use msg.rmf_robot_name</option>');
            
            if (node.rmfData.robots && node.rmfData.robots.length > 0) {
              node.rmfData.robots.forEach(robot => {
                if (robot.fleet === selectedFleet) {
                  robotSelect.append(`<option value="${robot.name}" data-fleet="${robot.fleet}">${robot.name} (${robot.fleet})</option>`);
                }
              });
            }
            
            // Restore selection if robot is from the selected fleet
            const robotFromFleet = node.rmfData.robots.find(r => r.name === currentRobot && r.fleet === selectedFleet);
            if (robotFromFleet) {
              robotSelect.val(currentRobot);
            }
          } else {
            // If "Use msg.rmf_robot_fleet" is selected, show all robots but don't reset selection
            const currentRobot = robotSelect.val();
            robotSelect.empty();
            robotSelect.append('<option value="">Use msg.rmf_robot_name</option>');
            
            if (node.rmfData.robots && node.rmfData.robots.length > 0) {
              node.rmfData.robots.forEach(robot => {
                robotSelect.append(`<option value="${robot.name}" data-fleet="${robot.fleet}">${robot.name} (${robot.fleet})</option>`);
              });
            }
            
            // Restore the current robot selection
            robotSelect.val(currentRobot);
          }
        });
      }
    }
  });
</script>

<script type="text/html" data-template-name="start-task">
  <div class="form-row">
    <label for="node-input-name">Name</label>
    <input type="text" id="node-input-name">
  </div>
  <div class="form-row">
    <label for="node-input-config"><i class="fa fa-cogs"></i> RMF Config</label>
    <input type="text" id="node-input-config" style="width: 60%;">
    <button type="button" id="refresh-rmf-data" class="red-ui-button" style="margin-left: 10px; width: auto;">
      <i class="fa fa-refresh"></i> Refresh Data
    </button>
  </div>
  
  <div class="form-row">
    <label for="node-input-robot_name">Robot Name</label>
    <select id="node-input-robot_name" style="width: 100%;">
      <option value="">Use msg.rmf_robot_name</option>
    </select>
  </div>
  
  <div class="form-row">
    <label for="node-input-robot_fleet">Robot Fleet</label>
    <select id="node-input-robot_fleet" style="width: 100%;">
      <option value="">Use msg.rmf_robot_fleet</option>
    </select>
  </div>
  
  <div class="form-row">
    <label for="node-input-estimate">Estimate (JSON)</label>
    <input type="text" id="node-input-estimate" placeholder='{"duration": 300}' style="width: 100%;">
  </div>
  
  <div class="form-tips">
    <b>Purpose:</b><br/>
    Creates and initializes RMF tasks for robots. This node handles the RMF task lifecycle and prepares robots for dynamic event execution.<br/><br/>
    
    <b>Setup Requirements:</b><br/>
    • Deploy and connect an RMF Config node first<br/>
    • Use "Refresh Data" button if dropdowns are empty<br/><br/>
    
    <b>Usage:</b><br/>
    • Robot name and fleet are required<br/>
    • Connect the success output to a goto-place node<br/>
    • The node will create a new RMF task and wait for it to reach standby status<br/>
    • Use "Use msg.xxx" dropdown options to pass values via message properties
  </div>
</script>

<script type="text/html" data-help-name="start-task">
  <p>Creates and initializes RMF tasks for robots. This node handles the RMF task lifecycle and prepares robots for dynamic event execution.</p>
  
  <h3>Configuration</h3>
  <dl class="message-properties">
    <dt>Robot Name <span class="property-type">string</span></dt>
    <dd>The name of the robot (required). Select from dropdown or use "Use msg.rmf_robot_name" to pass via message.</dd>
    
    <dt>Robot Fleet <span class="property-type">string</span></dt>
    <dd>The fleet the robot belongs to (required). Auto-selected when robot is chosen. Select from dropdown or use "Use msg.rmf_robot_fleet" to pass via message.</dd>
    
    <dt>Estimate <span class="property-type">object</span></dt>
    <dd>JSON object containing task estimates (optional). Example: {"duration": 300}</dd>
    
    <dt>Stubborn Period <span class="property-type">number</span></dt>
    <dd>How long the task should persist in seconds (default: 0)</dd>
    
    <dt>Parallel Behaviour <span class="property-type">string</span></dt>
    <dd>How to handle conflicting tasks: "abort", "overwrite", or "queue" (default: "abort")</dd>
  </dl>
  
  <h3>Inputs</h3>
  <dl class="message-properties">
    <dt>msg.rmf_robot_name <span class="property-type">string</span></dt>
    <dd>Robot name (used when "Use msg.rmf_robot_name" is selected)</dd>
    
    <dt>msg.rmf_robot_fleet <span class="property-type">string</span></dt>
    <dd>Robot fleet (used when "Use msg.rmf_robot_fleet" is selected)</dd>
    
    <dt>msg.robot_name <span class="property-type">string</span></dt>
    <dd>Robot name (fallback - for backward compatibility)</dd>
    
    <dt>msg.robot_fleet <span class="property-type">string</span></dt>
    <dd>Robot fleet (fallback - for backward compatibility)</dd>
    
    <dt>msg.estimate <span class="property-type">object</span></dt>
    <dd>Task estimates (optional)</dd>
  </dl>
  
  <h3>Outputs</h3>
  <ol class="node-ports">
    <li>Success
      <dl class="message-properties">
        <dt>payload.status <span class="property-type">string</span></dt>
        <dd>"ready" when task is successfully created and in standby</dd>
        <dt>payload.task_id <span class="property-type">string</span></dt>
        <dd>The RMF task ID</dd>
        <dt>payload.dynamic_event_seq <span class="property-type">number</span></dt>
        <dd>Dynamic event sequence number for this task</dd>
        <dt>payload.robot_name <span class="property-type">string</span></dt>
        <dd>The robot name</dd>
        <dt>payload.robot_fleet <span class="property-type">string</span></dt>
        <dd>The robot fleet</dd>
        <dt>msg.rmf_task_id <span class="property-type">string</span></dt>
        <dd>RMF task ID metadata for next nodes in workflow</dd>
        <dt>msg.rmf_robot_name <span class="property-type">string</span></dt>
        <dd>Robot name metadata for next nodes in workflow</dd>
        <dt>msg.rmf_robot_fleet <span class="property-type">string</span></dt>
        <dd>Robot fleet metadata for next nodes in workflow</dd>
      </dl>
    </li>
    <li>Failed
      <dl class="message-properties">
        <dt>payload.status <span class="property-type">string</span></dt>
        <dd>"failed", "cancelled", "waiting", or "error"</dd>
        <dt>payload.reason <span class="property-type">string</span></dt>
        <dd>Description of the failure</dd>
      </dl>
    </li>
  </ol>
  
  <h3>Details</h3>
  <p>This node is the first step in the RMF task workflow. It creates an RMF task for the specified robot and waits for it to reach standby status, which means the robot is ready to receive dynamic events.</p>
  
  <p><strong>Workflow:</strong> Connect start-task → goto-place → end-task for complete task lifecycle management.</p>
  
  <p><strong>Task Reuse:</strong> If a robot already has an active task, the node will reuse it based on the parallel behaviour setting.</p>
</script>
